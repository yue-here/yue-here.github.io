<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Classifier-free guidance for the Glyffuser | Yue Wu</title>
<meta name=keywords content><meta name=description content="


See the main Glyffuser article here"><meta name=author content="Yue Wu"><link rel=canonical href=http://localhost:1313/posts/glyffuser2/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/glyffuser2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/posts/glyffuser2/"><meta property="og:site_name" content="Yue Wu"><meta property="og:title" content="Classifier-free guidance for the Glyffuser"><meta property="og:description" content="See the main Glyffuser article here"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-12T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-12T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Classifier-free guidance for the Glyffuser"><meta name=twitter:description content="


See the main Glyffuser article here"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Classifier-free guidance for the Glyffuser","item":"http://localhost:1313/posts/glyffuser2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Classifier-free guidance for the Glyffuser","name":"Classifier-free guidance for the Glyffuser","description":"\rSee the main Glyffuser article here\n","keywords":[],"articleBody":"\rSee the main Glyffuser article here\nHere we test classifier-free guidance (CFG) as a method to enhance adherance to text conditioning. For the prompt “walk” (Chinese character 走), as we increase the CFG multiplier we end up with a double “walk” character that still follows the rules of Chinese glyph construction\nIntro Classifier-free guidance is an elegant and powerful technique that has recently become ubiquitous in conditional diffusion models. (For an excellent treatment, see here)\nEssentially, this method allows the strength of any given prompt to be varied without needing to perform any additional training. Moreover, the strength of the prompt can be increased far above that for standard conditional training.\nTo implement this method, we simply add random dropout of the text conditioning tokens during training (10-20% has been found to work well). This effectively trains an unconditional model at the same time. During sampling steps, we simply perform the noise prediction twice, once normally and once with a zero conditioning tensor. We then combine them as follows:\nnoise_prediction = noise_prediction_unconditional + guidance_scale * (noise_prediction - noise_prediction_unconditional)\nTip At guidance_scale = 0, the model acts as an unconditional model while at guidance_scale = 1, the model acts as the standard conditional model Testing CFG scales Generally, increasing guidance_scale in text-to-image models decreases variety while increasing adherence to the prompt. Let’s try probing the model by varying the number of sampling steps and guidance scale for the prompt “bird” corresponding to a very common radical (鳥/鸟):\nTip Unusually, the “bird” radical can occur on either the left (“鸵”, ostrich) or right (“鸡”， chicken) sides of characters. Compared to previously, we see that as we increase the guidance scale, the ‘bird’ radical becomes increasingly activated from the very first sampling step. Interestingly, while the traditional form of the bird character “鳥” dominates (it is more prevalent in the training set), the simplified form “鸟” also makes a single appearance (10 steps, scale=50), making it a ’transition state’ during the denoising process. The explorer below shows CFG scales of 0 to 100 for different random seeds - higher CFG scales do indeed reduce sample variety. Compared to general-purpose text-to-image models however, we can tolerate higher CFG scales as they tend to give more convincing characters. If you follow any individual character, you’ll see that it tends to start with one ‘bird’ radical, then as CFG scale increases, at some point the other side will also collapse to a ‘bird’ radical.\nPause\rCFG scale 1\rCFG generations for the most common radicals For completeness, the effect of CFG on all of our previous generations is shown below. Only for radicals such as ‘bird’, ‘fire’ (火) and ‘walk’ (走) do we see multiples - these are the radicals which in known characters can lie on different sides.\nBonus: CFG variations for “fire” The Chinese character for fire “火” has a particularly varied set of possible locations. These are showcased in the characters “炎” and “焱”. Another form is the bottom radical “灬”, a kind of deconstructed version of “火”. As such, greater variety is possible and this shows:\nPause\rCFG scale 1\rBonus: CFG variations for “hair” I’m mostly including this because the characters look very funny.\nPause\rCFG scale 1\r","wordCount":"537","inLanguage":"en","datePublished":"2024-06-12T00:00:00Z","dateModified":"2024-06-12T00:00:00Z","author":{"@type":"Person","name":"Yue Wu"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/glyffuser2/"},"publisher":{"@type":"Organization","name":"Yue Wu","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Yue Wu (Alt + H)">Yue Wu</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/index.html title=Home><span>Home</span></a></li><li><a href=http://localhost:1313/bio/ title=Bio><span>Bio</span></a></li><li><a href=http://localhost:1313/posts/ title=Posts><span>Posts</span></a></li><li><a href=http://localhost:1313/research/ title=Research><span>Research</span></a></li><li><a href=http://localhost:1313/personal/ title=Personal><span>Personal</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Classifier-free guidance for the Glyffuser
<span class=entry-hint title=Draft><svg height="35" viewBox="0 -960 960 960" fill="currentcolor"><path d="M160-410v-60h3e2v60H160zm0-165v-60h470v60H160zm0-165v-60h470v60H160zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22-4.5 22.5T862.09-380L643-160H520zm3e2-263-37-37 37 37zM580-220h38l121-122-18-19-19-18-122 121v38zm141-141-19-18 37 37-18-19z"/></svg></span></h1><div class=post-meta><span title='2024-06-12 00:00:00 +0000 UTC'>June 12, 2024</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;537 words&nbsp;·&nbsp;Yue Wu</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#intro>Intro</a></li><li><a href=#testing-cfg-scales>Testing CFG scales</a></li><li><a href=#cfg-generations-for-the-most-common-radicals>CFG generations for the most common radicals</a></li><li><a href=#bonus-cfg-variations-for-fire>Bonus: CFG variations for &ldquo;fire&rdquo;</a></li><li><a href=#bonus-cfg-variations-for-hair>Bonus: CFG variations for &ldquo;hair&rdquo;</a></li></ul></li></ul></nav></div></details></div><div class=post-content><script>document.addEventListener("DOMContentLoaded",e=>{function t(e,t,n,s,o){const a=document.getElementById(e),u=document.getElementById(t),h=document.getElementById(n),r=document.getElementById(s);let i=!0,c;function l(e){h.textContent=`CFG scale ${e}`,u.src=`/${o}_slider/${o}-CFG${e}_grid.png`}a.addEventListener("input",e=>{const t=e.target.value;l(t)}),r.addEventListener("click",()=>{i=!i,r.textContent=i?"Pause":"Play",i?d():clearInterval(c)});function d(){c=setInterval(()=>{let e=parseInt(a.value,10);e=(e+1)%100,a.value=e,l(e)},100)}d()}t("parameterSlider1","outputImage1","sliderValue1","autoplayButton1","bird"),t("parameterSlider2","outputImage2","sliderValue2","autoplayButton2","fire"),t("parameterSlider3","outputImage3","sliderValue3","autoplayButton3","hair")})</script><style>html,body{margin:0;padding:0;height:100%;overflow-x:hidden;box-sizing:border-box}*,*::before,*::after{box-sizing:inherit}.slider-container{max-width:100%;width:100%;margin:20px auto;display:flex;align-items:center;flex-wrap:nowrap;overflow:hidden}.parameterSlider{flex:1;margin-left:10px;min-width:0}.outputImage{display:block;margin:20px auto;max-width:100%}.sliderValue{min-width:100px;text-align:right;white-space:nowrap}.autoplayButton{min-width:60px;margin-right:10px;flex-shrink:0}</style><p><em>See the main Glyffuser article <a href=http://localhost:1313/posts/glyffuser/>here</a></em></p><center><figure><img loading=lazy src=/CFG%20grabber.png></figure><p><em>Here we test classifier-free guidance (CFG) as a method to enhance adherance to text conditioning. For the prompt &ldquo;walk&rdquo; (Chinese character 走), as we increase the CFG multiplier we end up with a double &ldquo;walk&rdquo; character that still follows the rules of Chinese glyph construction</em></p></center><br><h3 id=intro>Intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h3><p><a href=https://arxiv.org/abs/2207.12598>Classifier-free guidance</a> is an elegant and powerful technique that has recently become ubiquitous in conditional diffusion models. (For an excellent treatment, see <a href=https://sander.ai/2022/05/26/guidance.html>here</a>)</p><p>Essentially, this method allows the strength of any given prompt to be varied without needing to perform any additional training. Moreover, the strength of the prompt can be increased far above that for standard conditional training.</p><p>To implement this method, we simply add random dropout of the text conditioning tokens during training (10-20% has been found to work well). This effectively trains an unconditional model at the same time. During sampling steps, we simply perform the noise prediction twice, once normally and once with a zero conditioning tensor. We then combine them as follows:</p><p><code>noise_prediction = noise_prediction_unconditional + guidance_scale * (noise_prediction - noise_prediction_unconditional)</code></p><div class=admonition><div class=admonition-title-container><div class=admonition-title>Tip</div></div><div class=admonition-content>At <code>guidance_scale = 0</code>, the model acts as an unconditional model while at <code>guidance_scale = 1</code>, the model acts as the standard conditional model</div></div><h3 id=testing-cfg-scales>Testing CFG scales<a hidden class=anchor aria-hidden=true href=#testing-cfg-scales>#</a></h3><p>Generally, increasing <code>guidance_scale</code> in text-to-image models decreases variety while increasing adherence to the prompt. Let&rsquo;s try probing the model by varying the number of sampling steps and guidance scale for the prompt &ldquo;bird&rdquo; corresponding to a very common radical (鳥/鸟):</p><center><figure><img loading=lazy src=/cfg-steps%20grid.png></figure></center><div class=admonition><div class=admonition-title-container><div class=admonition-title>Tip</div></div><div class=admonition-content>Unusually, the &ldquo;bird&rdquo; radical can occur on either the left (&ldquo;鸵&rdquo;, ostrich) or right (&ldquo;鸡&rdquo;， chicken) sides of characters.</div></div><p>Compared to <a href=http://localhost:1313/posts/glyffuser/>previously</a>, we see that as we increase the guidance scale, the &lsquo;bird&rsquo; radical becomes increasingly activated from the very first sampling step. Interestingly, while the traditional form of the bird character &ldquo;鳥&rdquo; dominates (it is more prevalent in the training set), the simplified form &ldquo;鸟&rdquo; also makes a single appearance (10 steps, scale=50), making it a &rsquo;transition state&rsquo; during the denoising process. The explorer below shows CFG scales of 0 to 100 for different random seeds - higher CFG scales do indeed reduce sample variety. Compared to general-purpose text-to-image models however, we can tolerate higher CFG scales as they tend to give more convincing characters. If you follow any individual character, you&rsquo;ll see that it tends to start with one &lsquo;bird&rsquo; radical, then as CFG scale increases, at some point the other side will also collapse to a &lsquo;bird&rsquo; radical.</p><div class="slider-container unique-slider-container1"><button id=autoplayButton1 class=autoplayButton>Pause</button>
<span id=sliderValue1 class=sliderValue>CFG scale 1</span>
<input type=range min=0 max=99 step=1 value=1 id=parameterSlider1 class=parameterSlider></div><img id=outputImage1 class=outputImage src=/fire_slider/fire-CFG0_grid.png alt="Model Output"><h3 id=cfg-generations-for-the-most-common-radicals>CFG generations for the most common radicals<a hidden class=anchor aria-hidden=true href=#cfg-generations-for-the-most-common-radicals>#</a></h3><p>For completeness, the effect of CFG on all of our previous generations is shown below. Only for radicals such as &lsquo;bird&rsquo;, &lsquo;fire&rsquo; (火) and &lsquo;walk&rsquo; (走) do we see multiples - these are the radicals which in known characters can lie on different sides.</p><center><figure><img loading=lazy src=/guidance_scale_grid.png></figure></center><h3 id=bonus-cfg-variations-for-fire>Bonus: CFG variations for &ldquo;fire&rdquo;<a hidden class=anchor aria-hidden=true href=#bonus-cfg-variations-for-fire>#</a></h3><p>The Chinese character for fire &ldquo;火&rdquo; has a particularly varied set of possible locations. These are showcased in the characters &ldquo;炎&rdquo; and &ldquo;焱&rdquo;. Another form is the bottom radical &ldquo;灬&rdquo;, a kind of deconstructed version of &ldquo;火&rdquo;. As such, greater variety is possible and this shows:</p><div class="slider-container unique-slider-container2"><button id=autoplayButton2 class=autoplayButton>Pause</button>
<span id=sliderValue2 class=sliderValue>CFG scale 1</span>
<input type=range min=0 max=99 step=1 value=1 id=parameterSlider2 class=parameterSlider></div><img id=outputImage2 class=outputImage src=/bird_slider/bird-CFG0_grid.png alt="Model Output"><h3 id=bonus-cfg-variations-for-hair>Bonus: CFG variations for &ldquo;hair&rdquo;<a hidden class=anchor aria-hidden=true href=#bonus-cfg-variations-for-hair>#</a></h3><p>I&rsquo;m mostly including this because the characters look very funny.</p><div class="slider-container unique-slider-container3"><button id=autoplayButton3 class=autoplayButton>Pause</button>
<span id=sliderValue3 class=sliderValue>CFG scale 1</span>
<input type=range min=0 max=99 step=1 value=1 id=parameterSlider3 class=parameterSlider></div><img id=outputImage3 class=outputImage src=/hair_slider/hair-CFG0_grid.png alt="Model Output"></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/genai_intuitions/><span class=title>« Prev</span><br><span>An Illustrated Generative AI Primer</span>
</a><a class=next href=http://localhost:1313/posts/glyffuser/><span class=title>Next »</span><br><span>Teaching an AI to invent new Chinese characters</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Yue Wu</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>