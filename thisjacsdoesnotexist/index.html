<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>This JACS does not exist - Yue Wu</title><meta name="Description" content="Yue Wu"><meta property="og:title" content="This JACS does not exist" />
<meta property="og:description" content="An imaginary abstract generated at thisJACSdoesnotexist.com In academic chemistry, authors submit a promotional table-of-contents (ToC) image when publishing research papers in most journals. These fascinate me as they are one of the few places where unfettered self expression is tolerated, if not condoned. (See e.g. TOC ROFL, of which I am a multiple inductee)
In general, though, ToC images follow a fairly consistent visual language, with distinct conventions followed in different subfields." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yue-here.github.io/thisjacsdoesnotexist/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-01T00:56:40-07:00" />
<meta property="article:modified_time" content="2022-08-01T00:56:40-07:00" /><meta property="og:site_name" content="Yue Wu" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="This JACS does not exist"/>
<meta name="twitter:description" content="An imaginary abstract generated at thisJACSdoesnotexist.com In academic chemistry, authors submit a promotional table-of-contents (ToC) image when publishing research papers in most journals. These fascinate me as they are one of the few places where unfettered self expression is tolerated, if not condoned. (See e.g. TOC ROFL, of which I am a multiple inductee)
In general, though, ToC images follow a fairly consistent visual language, with distinct conventions followed in different subfields."/>
<meta name="application-name" content="Yue Wu">
<meta name="apple-mobile-web-app-title" content="Yue Wu"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://yue-here.github.io/thisjacsdoesnotexist/" /><link rel="next" href="https://yue-here.github.io/abstract2title/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "This JACS does not exist",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/yue-here.github.io\/thisjacsdoesnotexist\/"
        },"image": ["https:\/\/yue-here.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  1939 ,
        "url": "https:\/\/yue-here.github.io\/thisjacsdoesnotexist\/","datePublished": "2022-08-01T00:56:40-07:00","dateModified": "2022-08-01T00:56:40-07:00","publisher": {
            "@type": "Organization",
            "name": "xxxx","logo": "https:\/\/yue-here.github.io\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Yue Wu"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Yue Wu"><span class="header-title-pre"><i class='fa-solid fa-vial fa-fw' aria-hidden='true'></i></span>Yue Wu</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/bio/"> Bio </a><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/research/"> Research </a><a class="menu-item" href="/personal/"> Personal </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Yue Wu"><span class="header-title-pre"><i class='fa-solid fa-vial fa-fw' aria-hidden='true'></i></span>Yue Wu</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/bio/" title="">Bio</a><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/research/" title="">Research</a><a class="menu-item" href="/personal/" title="">Personal</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">This JACS does not exist</h1><h2 class="single-subtitle">Generating chemistry abstracts with machine learning</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Yue Wu</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-08-01">2022-08-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1939 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;10 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#training-the-gan">Training the GAN</a>
      <ul>
        <li><a href="#getting-the-dataset-ready">Getting the dataset ready</a></li>
        <li><a href="#running-stylegan3">Running StyleGAN3</a></li>
        <li><a href="#generating-fake-toc-images">Generating fake ToC images</a></li>
      </ul>
    </li>
    <li><a href="#assembling-a-toc-to-title-model">Assembling a ToC to title model</a>
      <ul>
        <li><a href="#fine-tuning-gpt-2-to-generate-paper-titles">Fine-tuning GPT-2 to generate paper titles</a></li>
        <li><a href="#choosing-a-vision-model">Choosing a vision model</a></li>
        <li><a href="#putting-it-all-together">Putting it all together</a></li>
      </ul>
    </li>
    <li><a href="#training-a-title-to-abstract-model">Training a title-to-abstract model</a></li>
    <li><a href="#test-the-models-here">Test the models here</a>
      <ul>
        <li><a href="#toc2title">Image to title generator</a></li>
        <li><a href="#title2abstract">Title to abstract generator</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><center>
<p><a href="http://thisjacsdoesnotexist.com/" target="_blank" rel="noopener noreffer "><figure><img src="/TJDNE_website_3.png"/><figcaption>
            <h4>An imaginary abstract generated at thisJACSdoesnotexist.com</h4>
        </figcaption>
</figure>
</a></p>
</center>
<p>In academic chemistry, authors submit a promotional table-of-contents (ToC) image when publishing research papers in most journals. These fascinate me as they are one of the few places where unfettered self expression is tolerated, if not condoned. (See e.g. <a href="https://tocrofl.tumblr.com/" target="_blank" rel="noopener noreffer ">TOC ROFL</a>, of which I am a multiple <a href="https://pubs.acs.org/cms/10.1021/acs.chemmater.5b03085/asset/images/medium/cm-2015-030857_0005.gif" target="_blank" rel="noopener noreffer ">inductee</a>)</p>
<p>In general, though, ToC images follow a fairly consistent visual language, with distinct conventions followed in different subfields. This presents an vaguely plausible excuse to train some machine learning models to generate ToCs and their accompanying paraphenalia. In this project, I use ToC images, titles and abstracts from one of the most longest running and well-known chemistry journals, the Journal of the American Chemical Society (<a href="https://pubs.acs.org/journal/jacsat" target="_blank" rel="noopener noreffer ">JACS</a>) as a dataset to train:</p>
<ol>
<li>A generative adversarial network (<a href="https://github.com/NVlabs/stylegan3" target="_blank" rel="noopener noreffer ">StyleGAN3</a>) - a model which learns to generate images similar to those in its training set.</li>
<li>A finetuned version of <a href="https://openai.com/blog/better-language-models/" target="_blank" rel="noopener noreffer ">GPT-2</a> that generates chemistry-paper-title-like lists of words.</li>
<li>A <a href="https://huggingface.co/docs/transformers/model_doc/vision-encoder-decoder" target="_blank" rel="noopener noreffer ">vision encoder-decoder model</a> (<a href="#toc2title" rel="">test it out here</a>) that converts images to the appropriate text - here, the above GPT-2 model acts as the text generator.</li>
<li>A <a href="https://huggingface.co/docs/transformers/model_doc/t5" target="_blank" rel="noopener noreffer ">T5 sequence-to-sequence model</a> (<a href="#title2abstract" rel="">test it out here</a>) that generates a text sequence from a prompt.</li>
</ol>
<p>For those who are interested in the inner workings or may want to do something similar, I&rsquo;ve included a writeup of the project below. Examples of the code are available on my <a href="https://github.com/yue-here/tocgan" target="_blank" rel="noopener noreffer ">GitHub</a>. As you&rsquo;ll see, a lot of my choices were fairly abitrary, arising more-or-less from the availability heuristic.</p>
<h2 id="training-the-gan">Training the GAN</h2>
<h3 id="getting-the-dataset-ready">Getting the dataset ready</h3>
<p>My initial idea was simply to see how well a GAN could generate ToC images, and so I needed a whole bunch of ToC images. I used the popular python package beautifulsoup with a headless browser and some simple loops to scrape the JACS website for the ToC images, titles and abstracts. The full dataset from around 60,000 papers could be collected overnight. Note: this was relatively easy with JACS (and ACS journals in general) as the website organisation follows a logical structure. YMMV for other publishers&rsquo; platforms.</p>
<p>Generally, ML training inputs for image models should be the same size, often with powers of 2 as values - StyleGAN3 uses square images of size 128, 256, 512, and 1024 pixels. Luckily, JACS ToC images are fixed to 500 pixels in width and maximum height. I padded the figures to 512x512 using Irfanview&rsquo;s batch processing tool, then resized those images to generate smaller datasets at 128 and 256 px as well.</p>
<h3 id="running-stylegan3">Running StyleGAN3</h3>
<p>I chose StyleGAN3 as I had heard of it before and 3 was the latest version number. At the time of writing it appears to be one of the best &amp; most mature GANs for image generation. The implementation is fairly user-friendly and includes various data preparation and training scripts; the documentation is excellent and deserves commendation.</p>
<p>The first step was to use the dataset_tool.py script to prepare a dataset in a form the model could use - something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Shell" data-lang="Shell"><span class="line"><span class="cl">python dataset_tool.py --source<span class="o">=</span><span class="s2">&#34;C:\...\512px&#34;</span> --dest<span class="o">=</span><span class="s2">&#34;C:\...\512px.zip&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After this, it&rsquo;s straightforward to train the model using the following script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Shell" data-lang="Shell"><span class="line"><span class="cl">python train.py --outdir<span class="o">=</span><span class="s2">&#34;C:\...\training_runs&#34;</span> --cfg<span class="o">=</span>stylegan3-t --data<span class="o">=</span><span class="s2">&#34;C:\...\512px.zip&#34;</span> --gpus<span class="o">=</span><span class="m">1</span> --batch<span class="o">=</span><span class="m">32</span> --gamma<span class="o">=</span><span class="m">8</span> --batch-gpu<span class="o">=</span><span class="m">8</span> --snap<span class="o">=</span><span class="m">10</span> --cbase<span class="o">=</span><span class="m">16384</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The key parameters that need to be set are batch size and gamma, which is the R1 regularization parameter. &lsquo;cbase=16384&rsquo; speeds up training by sacrificing network capacity, but at low resolutions I didn&rsquo;t find it to be a problem. Having only a humble RTX 3060 Ti (the best I could get during the GPU apocalypse of 2020-2021), the meagre 8 GB of VRAM was a limiting factor for batch sizes. I also found useful the &ndash;resume flag, which allows you to resume training from a previous network snapshot in case of crashes, although I found I also had to edit the resume_kimgs variable in the training script directly to get it to work properly. The tensorbard output is also very good, and can be run like so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Shell" data-lang="Shell"><span class="line"><span class="cl">tensorboard --logdir <span class="s2">&#34;C:\...\&lt;training run directory&gt;&#34;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>I considered training on cloud compute but seemed to be more expensive than training locally, and also required learning a new thing. In retrospect this might have been a poor life choice. My wife was still annoyed that our power bill doubled during the month I was training though! Also that the computer was essentially a fan heater running in the bedroom during the height of summer. After bluescreening a couple of times I removed the computer side panel which dropped temps by a couple of degrees.</p>
<center>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/fakes_128px.png"
        data-srcset="/fakes_128px.png, /fakes_128px.png 1.5x, /fakes_128px.png 2x"
        data-sizes="auto"
        alt="/fakes_128px.png"
        title="128px" /></p>
<p>Fakes generated from a model trained on 128 px images</p>
</center>
 I ran a first test with a 128 px as proof of concept, which was convincing enough that I scaled up to 256 px. 
 In principle resolutions of up to 1024 px are available, but the raw data resolution mean that going above 512 was meaningless, and compute requirements made that unfeasible on my home system. 
<p>After training continuously for a few weeks, the 256 px model started to converge. In this case I used a common evaluation metric for GANs called the Fréchet Inception Distance (FID), a measure of similarity between image distributions. Below is a video of images generated from the model as it trains - each successive frame, the models has trained on an additional 40,000 images. Overall, the model saw images from the training set around 5 million times.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube-nocookie.com/embed/K4JdoLxgoUQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<center>GAN training progress video</center>
<h3 id="generating-fake-toc-images">Generating fake ToC images</h3>
<p>With the GAN model trained, it was time to generate the fake ToC images. This is done very simply with this StyleGAN script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Shell" data-lang="Shell"><span class="line"><span class="cl">python gen_images.py --outdir<span class="o">=</span><span class="s2">&#34;C:\...\output&#34;</span> --trunc<span class="o">=</span>0.8 --seeds<span class="o">=</span>0-50000 --network<span class="o">=</span><span class="s2">&#34;C:\...\network-snapshot-....pkl&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The key parameters here are ψ (&ldquo;trunc&rdquo;), which controls the tradeoff between image quality and weirdness (higher values are weirder). Some examples below:</p>
<center>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi02_1.png"
        data-srcset="/psi02_1.png, /psi02_1.png 1.5x, /psi02_1.png 2x"
        data-sizes="auto"
        alt="/psi02_1.png"
        title="psi02" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi02_2.png"
        data-srcset="/psi02_2.png, /psi02_2.png 1.5x, /psi02_2.png 2x"
        data-sizes="auto"
        alt="/psi02_2.png"
        title="psi02" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi02_3.png"
        data-srcset="/psi02_3.png, /psi02_3.png 1.5x, /psi02_3.png 2x"
        data-sizes="auto"
        alt="/psi02_3.png"
        title="psi02" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi02_4.png"
        data-srcset="/psi02_4.png, /psi02_4.png 1.5x, /psi02_4.png 2x"
        data-sizes="auto"
        alt="/psi02_4.png"
        title="psi02" />
<br>ψ = 0.2
<br><br></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi08_1.png"
        data-srcset="/psi08_1.png, /psi08_1.png 1.5x, /psi08_1.png 2x"
        data-sizes="auto"
        alt="/psi08_1.png"
        title="psi08" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi08_2.png"
        data-srcset="/psi08_2.png, /psi08_2.png 1.5x, /psi08_2.png 2x"
        data-sizes="auto"
        alt="/psi08_2.png"
        title="psi08" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi08_3.png"
        data-srcset="/psi08_3.png, /psi08_3.png 1.5x, /psi08_3.png 2x"
        data-sizes="auto"
        alt="/psi08_3.png"
        title="psi08" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi08_4.png"
        data-srcset="/psi08_4.png, /psi08_4.png 1.5x, /psi08_4.png 2x"
        data-sizes="auto"
        alt="/psi08_4.png"
        title="psi08" />
<br>ψ = 0.8
<br><br></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi11_1.png"
        data-srcset="/psi11_1.png, /psi11_1.png 1.5x, /psi11_1.png 2x"
        data-sizes="auto"
        alt="/psi11_1.png"
        title="psi11" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi11_2.png"
        data-srcset="/psi11_2.png, /psi11_2.png 1.5x, /psi11_2.png 2x"
        data-sizes="auto"
        alt="/psi11_2.png"
        title="psi11" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi11_3.png"
        data-srcset="/psi11_3.png, /psi11_3.png 1.5x, /psi11_3.png 2x"
        data-sizes="auto"
        alt="/psi11_3.png"
        title="psi11" /><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/psi11_4.png"
        data-srcset="/psi11_4.png, /psi11_4.png 1.5x, /psi11_4.png 2x"
        data-sizes="auto"
        alt="/psi11_4.png"
        title="psi11" />
<br>ψ = 1.1
<br><br></p>
</center>
<h2 id="assembling-a-toc-to-title-model">Assembling a ToC to title model</h2>
<p>With generated ToC images in hand, I wondered if it was possible to generate relevant paper titles. Having labels in the form of titles for all the ToCs in the training set, the challenge was finding an appropriate model. After trying a couple of things, I settled on using 🤗 Hugging Face&rsquo;s transformers library, mostly due to its good documentation and straightforward code structuring.</p>
<p>I used the <a href=https://huggingface.co/docs/transformers/model_doc/vision-encoder-decoder> 🤗 vision encoder decoder model</a> as the basis for the toc-to-title model. This model can easily be warm-started with a pretrained vision transformer plus a pretrained language transformer model. This is very convenient as big tech companies have already spent millions of dollars and vast amounts of compute training models which then can be easily fine-tuned or even just used out-of-the-box.</p>
<h3 id="fine-tuning-gpt-2-to-generate-paper-titles">Fine-tuning GPT-2 to generate paper titles</h3>
<p>I chose GPT-2 as the base for the language model. Once considered too <a href="https://openai.com/blog/better-language-models/" target="_blank" rel="noopener noreffer ">dangerous</a> to fully release, GPT-2 is now the most popular model hosted on Hugging Face. Much more powerful (and presumably commensurately dangerous) models such as the 20 billion parameter GPT-NeoX are now available (cf. the mere 1.5B parameters of GPT-2), however for the purposes of this project the relative computational tractability of tuning GPT-2 makes it an excellent choice.</p>
<p>GPT-2 is based on what is known as a decoder-only model (at this point, what I&rsquo;ll dubb &ldquo;Godwin&rsquo;s law but for AI&rdquo; comes into effect - as the length of this ML article increases, the probability that I&rsquo;ll direct you to the original transformers paper, <a href=https://arxiv.org/abs/1706.03762>&ldquo;Attention Is All You Need&rdquo; </a>, approaches 1). These models are good for text generation, but the base model is designed to generate text of an arbitrary length, so I had to make a couple of tweaks to get the model to generate paper-title-style sentences.</p>
<p>Language models such a GPT-2 first tokenize their inputs - that is, they break human-readable language into a set of tokens that may have some relationship to the underlying structure of the language, such as words, subwords, or in the case of GPT-2 <a href="https://huggingface.co/course/chapter6/5" target="_blank" rel="noopener noreffer ">byte-pair</a> encoding. Additionally, tokens for special occurences such as beginning/end of sequence, or padding, can be used. As GPT-2 only uses end-of-sequence tokens by default, I added a padding token &ldquo;&lt;|pad|&gt;&rdquo; to distinguish between the padding required for setting all training inputs to the same size, and the actual end of a title. As a rank amateur, this took quite a long time to work out so I share it here in the hope that it may be helpful to someone. I may do a full writeup in a separate post. Sample code below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">GPT2Tokenizer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">text_processor</span> <span class="o">=</span> <span class="n">GPT2Tokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&#34;gpt2&#34;</span><span class="p">,</span> <span class="n">pad_token</span><span class="o">=</span><span class="s2">&#34;&lt;|pad|&gt;&#34;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>I then appended end-of-sequence tokens to each of the training outputs. Finally, it&rsquo;s imporant to resize the token embeddings of the model so that the extra token is accounted for:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForCausalLM</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&#34;gpt2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># To account for extra padding token</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span><span class="o">.</span><span class="n">resize_token_embeddings</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_processor</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Having done that, the model can then be trained and produces convincing results. Here&rsquo;s a sample of real titles compared to GPT-2-JACS completions using the first 4 words of the real title as a prompt:</p>
<table>
<thead>
<tr>
<th>Real</th>
<th>GPT-2-JACS completion</th>
</tr>
</thead>
<tbody>
<tr>
<td>Origin of Dark-Channel X-ray Fluorescence from Transition-Metal Ions in Water</td>
<td>Origin of Dark-Channel X-ray Absorption Fine Structure of (NH3)4Ca(OH)5 in Supercritical Carbon Dioxide</td>
</tr>
<tr>
<td>Comprehensive Thermochemistry of W–H Bonding in the Metal Hydrides CpW(CO)2(IMes)H, [CpW(CO)2(IMes)H]•+, and [CpW(CO)2(IMes)(H)2]+. Influence of an N-Heterocyclic Carbene Ligand on Metal Hydride Bond Energies</td>
<td>Comprehensive Thermochemistry of W–H and H–H Bonds in the Lanthanide Phosphate (Ln5Me4) System</td>
</tr>
<tr>
<td>Fragmentation Energetics of Clusters Relevant to Atmospheric New Particle Formation</td>
<td>Fragmentation Energetics of Clusters Based on Cluster Modification: Assignment of the Concentration-Dependent Rate Constant</td>
</tr>
<tr>
<td>Transient Photoconductivity of Acceptor-Substituted Poly(3-butylthiophene)</td>
<td>Transient Photoconductivity of Acceptor-Substituted Layered Zirconium Oxides</td>
</tr>
<tr>
<td>Palladium-Catalyzed Aerobic Oxidative Cyclization of N-Aryl Imines: Indole Synthesis from Anilines and Ketones</td>
<td>Palladium-Catalyzed Aerobic Oxidative Cyclization of Unactivated Alkenes</td>
</tr>
<tr>
<td>Mild Aerobic Oxidative Palladium (II) Catalyzed C−H Bond Functionalization:  Regioselective and Switchable C−H Alkenylation and Annulation of Pyrroles</td>
<td>Mild Aerobic Oxidative Palladium(II)-Catalyzed Arylation of Indoles: Access to Chiral Olefins</td>
</tr>
<tr>
<td>A Pentacoordinate Boron-Containing π-Electron System with Cl–B–Cl Three-Center Four-Electron Bonds</td>
<td>A Pentacoordinate Boron-Containing π-Electron System for High-Performance Polymer Solar Cells</td>
</tr>
<tr>
<td>Ferroelectric Alkylamide-Substituted Helicene Derivative with Two-Dimensional Hydrogen-Bonding Lamellar Phase</td>
<td>Ferroelectric Alkylamide-Substituted Helicene Derivative: Synthesis, Characterization, and Redox Properties</td>
</tr>
<tr>
<td>Tandem Cyclopropanation/Ring-Closing Metathesis of Dienynes</td>
<td>Tandem Cyclopropanation/Ring-Closing Metathesis of Cyclohexadienes: Convergent Access to Optically Active α-Hydroxy Esters</td>
</tr>
<tr>
<td>Cyclic Penta-Twinned Rhodium Nanobranches as Superior Catalysts for Ethanol Electro-oxidation</td>
<td>Cyclic Penta-Twinned Rhodium Nanobranches: Isolation, Structural Characterization, and Catalytic Activity</td>
</tr>
</tbody>
</table>
<h3 id="choosing-a-vision-model">Choosing a vision model</h3>
<p>Vision transformer models seem to have superceded CNNs as cutting edge vision models. Initially (and perhaps still) I thought that fine-tuning a vision transformer such as <a href="https://huggingface.co/docs/transformers/model_doc/vit" target="_blank" rel="noopener noreffer ">ViT</a> or <a href="https://huggingface.co/docs/transformers/model_doc/swin" target="_blank" rel="noopener noreffer ">Swin</a> would be the way to go. I tried pre-training both of these with masked image modelling (helpful repo <a href="https://github.com/huggingface/transformers/tree/main/examples/pytorch/image-pretraining" target="_blank" rel="noopener noreffer ">here</a>), which uses a partially masked version of original images as training data and the unmasked version as the ground truth. However in the end the vanilla <a href="https://huggingface.co/docs/transformers/model_doc/beit" target="_blank" rel="noopener noreffer ">BEiT</a> proved to work better out of the box. A reminder to not reinvent wheels.</p>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>Once the vision and language models are selected, its a simple matter of combining them then training the model via the standard transformers api. (Full writeup in subsequent post)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-Python" data-lang="Python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">BeitConfig</span><span class="p">,</span> <span class="n">GPT2Config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Load pretrained components</span>
</span></span><span class="line"><span class="cl"><span class="n">config_encoder</span> <span class="o">=</span> <span class="n">BeitConfig</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&#34;microsoft/beit-base-patch16-224-pt22k-ft22k&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">config_decoder</span> <span class="o">=</span> <span class="n">GPT2Config</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&#34;local model folder/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># set decoder config to causal lm</span>
</span></span><span class="line"><span class="cl"><span class="n">config_decoder</span><span class="o">.</span><span class="n">is_decoder</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">config_decoder</span><span class="o">.</span><span class="n">add_cross_attention</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span> <span class="o">=</span> <span class="n">VisionEncoderDecoderConfig</span><span class="o">.</span><span class="n">from_encoder_decoder_configs</span><span class="p">(</span><span class="n">config_encoder</span><span class="p">,</span> <span class="n">config_decoder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initializing the model</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">VisionEncoderDecoderModel</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="training-a-title-to-abstract-model">Training a title-to-abstract model</h2>
<p>Section to be completed.</p>
<h2 id="test-the-models-here">Test the models here</h2>
<p>I&rsquo;ve generated huggingface spaces with gradio apps - they are embedded below if you want to test the models.</p>
<h3 id="toc2title">Image to title generator</h3>
<script type="module" src="https://gradio.s3-us-west-2.amazonaws.com/3.1.4/gradio.js">
</script>
<gradio-app space="yuewu/tocgen"></gradio-app>
<h3 id="title2abstract">Title to abstract generator</h3>
<script type="module" src="https://gradio.s3-us-west-2.amazonaws.com/3.1.4/gradio.js">
</script>
<gradio-app space="yuewu/title2abstract"></gradio-app>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-08-01</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/thisjacsdoesnotexist/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://yue-here.github.io/thisjacsdoesnotexist/" data-title="This JACS does not exist" data-via="_yue_wu"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://yue-here.github.io/thisjacsdoesnotexist/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://yue-here.github.io/thisjacsdoesnotexist/" data-title="This JACS does not exist"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://yue-here.github.io/thisjacsdoesnotexist/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/abstract2title/" class="next" rel="next" title="Abstract2title">Abstract2title<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Yue Wu</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"search":{"algoliaAppID":"","algoliaIndex":"","algoliaSearchKey":"","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
